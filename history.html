<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lịch sử mua hàng - ONEGEAR</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/layout.css" />
    
    <style>
      .history-section {
        margin-top: 3rem;
        min-height: 60vh;
      }
      .order-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .order-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      .order-id {
        font-weight: bold;
        color: #db4444;
      }
      .order-status {
        background: #cce5ff;
        color: #004085;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
      }
      .order-item {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        align-items: center;
      }
      .order-item img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border: 1px solid #f0f0f0;
        border-radius: 4px;
      }
      .total-price {
        font-size: 1.8rem;
        font-weight: bold;
        color: #db4444;
        text-align: right;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid container">
        <a class="navbar-brand nav-logo" href="./index.html">ONEGEAR</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0 nav-list">
            <li class="nav-item">
              <a class="nav-link" href="./index.html">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./contact.html">Liên hệ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./signup.html">Đăng ký</a>
            </li>
          </ul>
          <div class="d-flex align-items-center nav-items">
            <a href="./cart.html" class="text-dark text-decoration-none">
              <i class="fa fa-cart-shopping ms-3 nav-cart actived"></i>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <section class="section history-section">
      <div class="container">
        <h2 class="mb-4">Lịch sử đơn hàng của bạn</h2>

        <div id="order-history-list">
          <div class="text-center">
            <div class="spinner-border text-danger" role="status"></div>
            <p>Đang tải dữ liệu...</p>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container footer-container">
        <div class="footer-item">
          <a href="#" class="footer-logo">ONEGEAR</a>
          <div class="footer-p">
            Chúng tôi chuyên cung cấp gaming gear chính hãng, giá tốt, bảo hành
            minh bạch và hỗ trợ khách hàng nhanh chóng. Cam kết mang đến trải
            nghiệm mua sắm uy tín và tận tâm nhất cho anh em game thủ.
          </div>
        </div>
        <div class="footer-item">
          <h3 class="footer-title">Hỗ trợ</h3>
          <ul class="footer-list">
            <li class="footer-list-item">
              Số 55 Giải Phóng, Đồng Tâm, Đống Đa, Hà Nội
            </li>
            <li class="footer-list-item">cskh@onegear.vn</li>
            <li class="footer-list-item">+84969015828</li>
          </ul>
        </div>
        <div class="footer-item">
          <h3 class="footer-title">Tài khoản</h3>
          <ul class="footer-list">
            <li class="footer-list-item">Tài khoản của tôi</li>
            <li class="footer-list-item">Đăng nhập / Đăng ký</li>
            <li class="footer-list-item">Giỏ hàng</li>
            <li class="footer-list-item">Danh sách yêu thích</li>
            <li class="footer-list-item">Cửa hàng</li>
          </ul>
        </div>
        <div class="footer-item">
          <h3 class="footer-title">Liên kết nhanh</h3>
          <ul class="footer-list">
            <li class="footer-list-item">Chính sách bảo mật</li>
            <li class="footer-list-item">Điều khoản sử dụng</li>
            <li class="footer-list-item">Câu hỏi thường gặp</li>
            <li class="footer-list-item">Liên hệ</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="container footer-bottom-container">
          <div class="footer-copyright">
            &#169; Copyright 2025 ONEGEAR. All right reserved
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script/auth_check.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("order-history-list");

        // 1. Kiểm tra đăng nhập
        const currentUser = JSON.parse(
          localStorage.getItem("ONEGEAR_CURRENT_USER")
        );

        if (!currentUser) {
          container.innerHTML = `
                    <div class="text-center py-5">
                        <h4>Bạn chưa đăng nhập!</h4>
                        <p>Vui lòng đăng nhập để xem lịch sử mua hàng.</p>
                        <a href="./login.html" class="btn btn-danger">Đăng nhập ngay</a>
                    </div>
                `;
          return;
        }

        // 2. Lấy dữ liệu lịch sử
        const allOrders =
          JSON.parse(localStorage.getItem("ONEGEAR_ORDER_HISTORY")) || [];

        // 3. Lọc đơn hàng của user hiện tại (so sánh email)
        const myOrders = allOrders.filter(
          (order) => order.customer.email === currentUser.email
        );

        if (myOrders.length === 0) {
          container.innerHTML = `<p class="text-center py-5 text-muted">Bạn chưa có đơn hàng nào.</p>`;
          return;
        }

        // 4. Render ra HTML
        let html = "";
        myOrders.forEach((order) => {
          // Tạo list sản phẩm
          let itemsHtml = order.items
            .map(
              (item) => `
                    <div class="order-item">
                        <img src="${
                          item.image
                        }" onerror="this.src='./img/keyboard/keyboard1.jpg'">
                        <div>
                            <div style="font-weight: 500;">${item.name}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Intl.NumberFormat("vi-VN", {
                                  style: "currency",
                                  currency: "VND",
                                }).format(item.price)} x ${item.quantity}
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <span class="order-id"><i class="fas fa-receipt"></i> ${
                                  order.id
                                }</span>
                                <span class="text-muted ms-2" style="font-size: 0.9em;">(${
                                  order.date
                                })</span>
                            </div>
                        </div>
                        
                        <div class="order-body">
                            ${itemsHtml}
                        </div>
                        
                        <div class="total-price">
                            Tổng tiền: ${new Intl.NumberFormat("vi-VN", {
                              style: "currency",
                              currency: "VND",
                            }).format(order.total)}
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      });
    </script>
  </body>
</html>
